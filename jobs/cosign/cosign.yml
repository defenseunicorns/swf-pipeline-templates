sign-image:
  stage: sign-image
  needs: [ skopeo, build-image ]
  allow_failure: true
  image:
    name: cgr.dev/chainguard/cosign:latest
  variables:
    COSIGN_YES: "true" # Used by Cosign to skip confirmation prompts for non-destructive operations
  id_tokens:
    SIGSTORE_ID_TOKEN: # Used by Cosign to get certificate from Fulcio
      aud: sigstore
  script:
    - DIGEST=$(cat $ARTIFACT_FOLDER/registry_digest)
    - cosign version
    - cosign login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - cosign sign --key ${COSIGN_KEY} --tlog-upload=false "${CI_REGISTRY_IMAGE}@${DIGEST}"
