skopeo:
  stage: push-image
  # needs: [ clamav, grype, trivy, build-image ]
  needs:
    - job: clamav
      optional: true
    - job: grype
      optional: true
    - job: trivy
      optional: true
    - job: build-image
  image: 
    name: alpine:latest
  variables:
    GIT_STRATEGY: none
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - $ARTIFACT_FOLDER/registry_digest
  script:
    - apk add skopeo
    - skopeo --version
    - skopeo --debug copy
      --dest-creds ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}
      docker-archive:"$ARTIFACT_FOLDER/image-as-tar/${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}.tar"
      docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - skopeo inspect --format='{{.Digest}}' docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} > $ARTIFACT_FOLDER/registry_digest
  
