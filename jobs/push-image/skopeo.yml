skopeo:
  stage: push-image
  needs: [ clamav, grype, trivy, build-image ]
  image: 
    name: quay.io/skopeo/stable@sha256:e7e168b9e7b185f2bdcc266b36661b4da291eb9e2555a4a79b29dd4cc992681b
  variables:
    GIT_STRATEGY: none
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - $ARTIFACT_FOLDER/registry_digest
  script:
    - skopeo --version
    - skopeo --debug copy
      --dest-creds ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD}
      docker-archive:"$ARTIFACT_FOLDER/image-as-tar/${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}.tar"
      docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - skopeo inspect --creds ${CI_REGISTRY_USER}:${CI_REGISTRY_PASSWORD} --format='{{.Digest}}' docker://${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} > $ARTIFACT_FOLDER/registry_digest