zarf-pkg:
  stage: zarf-pkg
  allow_failure: true
  image:
    name: lucasrod96/zarf:v0.0.1
  variables:
    DESTINATION_REGISTRY: "oci://${CI_REGISTRY_IMAGE}"
  artifacts:
    expire_in: 1 day
    paths:
      - zarf-package-*.zst
  script:
    - zarf version
    - echo ${CI_REGISTRY_PASSWORD} | zarf tools registry login ${CI_REGISTRY} --username ${CI_REGISTRY_USER} --password-stdin
    - zarf package create . --confirm --set VERSION=${CI_COMMIT_SHORT_SHA} --set IMAGE=${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - zarf package publish zarf-package-*.tar.zst ${DESTINATION_REGISTRY}
    
